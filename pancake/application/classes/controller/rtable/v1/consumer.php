<?php        defined('SYSPATH') OR die('No direct access allowed.');        /**         * Pancake Controller consumer         *          * Created Oct 11, 2012 5:28:45 PM         * @author equemuel         */        class Controller_Rtable_v1_Consumer extends Controller_Templates_APIv1        {            public function action_login()            {                $consumer_email = Arr::get($_REQUEST, 'consumer_email', NULL);                $event_code = Arr::get($_REQUEST, 'event_code', NULL);                $data = array();                if ($event_code && $consumer_email)                {                    $result = DB::select('e.id')                        ->from(array('event', 'e'))                        ->join(array('consumer_has_event', 'che'))                        ->on('e.id', '=', 'che.event_id')                        ->join(array('consumer', 'c'))                        ->on('c.id', '=', 'che.consumer_id')                        ->where('c.email', '=', $consumer_email)                        ->where('e.event_code', '=', $event_code)                        ->execute($this->client['database'])                        ->as_array();                    if ($result)                    {                        $event_id = $result[0]['id'];                        if ($result)                        {                            $message = 'Consumer login successful';                            $data['event_id'] = $event_id;                            $data['session_id'] = $this->session_id;                            $output = PancakeResponse::out(TRUE, $message, $data);                        }                        else                        {                            $message = 'Wrong email/event code combination';                            $status = FALSE;                            $output = PancakeResponse::out($status, $message);                        }                    }                    else                    {                        $message = 'Invalid email/event code combination.';                        $status = FALSE;                        $output = PancakeResponse::out($status, $message);                    }                }                else                {                    $message = 'Event code and consumer email cannot be empty';                    $status = FALSE;                    $output = PancakeResponse::out($status, $message);                }                echo $output;                $this->template->content = $output;            }        }